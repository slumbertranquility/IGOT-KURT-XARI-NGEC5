import { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { useScrollProgress } from './hooks/useScrollProgress';
import { ScrollProgressBar } from './components/ScrollProgressBar';
import { CustomCursor } from './components/CustomCursor';
import { BicycleSVG } from './components/BicycleSVG';
import { ParallaxScene } from './components/ParallaxScene';
import { ParticleTrail } from './components/ParticleTrail';
import { QuoteBreakdownCards } from './components/QuoteBreakdownCards';
import { BalancePlayground } from './components/BalancePlayground';
import { Footer } from './components/Footer';

// Console Easter egg
console.log('%cKeep moving. ðŸš² â€” Einstein', 'font-size: 16px; color: #f5a623; font-style: italic;');

const QUOTE_WORDS = [
  { text: '"Life', milestone: 0.05 },
  { text: 'is just like', milestone: 0.1 },
  { text: 'riding a bicycle.', milestone: 0.17 },
  { text: 'In order to balance,', milestone: 0.25 },
  { text: 'you must keep moving."', milestone: 0.32 },
];

export function App() {
  const { progress, velocity, isScrolling, direction } = useScrollProgress();

  // Section-specific progress calculations
  const heroProgress = Math.min(1, Math.max(0, progress / 0.15));
  const rideProgress = Math.min(1, Math.max(0, (progress - 0.05) / 0.35));
  const showcaseProgress = Math.min(1, Math.max(0, (progress - 0.4) / 0.15));
  const cardsProgress = Math.min(1, Math.max(0, (progress - 0.55) / 0.15));
  // playgroundProgress available if needed for future enhancements
  void Math.min(1, Math.max(0, (progress - 0.7) / 0.15));

  // Bicycle state
  const [bikeAssembled, setBikeAssembled] = useState(false);
  const [bikeFallen, setBikeFallen] = useState(false);
  const [wobbleLevel, setWobbleLevel] = useState(0);
  const [showKeepMoving, setShowKeepMoving] = useState(false);
  const [showReverse, setShowReverse] = useState(false);
  const lastScrollTime = useRef(Date.now());
  const wobbleTimer = useRef<ReturnType<typeof setInterval>>(undefined);
  const fallTimer = useRef<ReturnType<typeof setTimeout>>(undefined);

  // Assemble animation
  useEffect(() => {
    const timer = setTimeout(() => setBikeAssembled(true), 2200);
    return () => clearTimeout(timer);
  }, []);

  // Wheel rotation based on velocity
  const wheelRotation = useRef(0);
  useEffect(() => {
    wheelRotation.current += velocity * 2;
  }, [velocity]);

  // Balance / wobble / fall mechanic
  useEffect(() => {
    if (progress < 0.05 || progress > 0.4) return;

    if (isScrolling) {
      lastScrollTime.current = Date.now();
      setBikeFallen(false);
      setWobbleLevel(0);
      setShowKeepMoving(false);

      if (wobbleTimer.current) clearInterval(wobbleTimer.current);
      if (fallTimer.current) clearTimeout(fallTimer.current);
      return;
    }

    // Not scrolling - start wobble countdown
    wobbleTimer.current = setInterval(() => {
      const elapsed = Date.now() - lastScrollTime.current;
      if (elapsed > 2000 && elapsed <= 4000) {
        setWobbleLevel(1);
      } else if (elapsed > 4000 && elapsed <= 5000) {
        setWobbleLevel(2);
      } else if (elapsed > 5000) {
        setWobbleLevel(0);
        setBikeFallen(true);
        setShowKeepMoving(true);
        if (wobbleTimer.current) clearInterval(wobbleTimer.current);
      }
    }, 100);

    return () => {
      if (wobbleTimer.current) clearInterval(wobbleTimer.current);
      if (fallTimer.current) clearTimeout(fallTimer.current);
    };
  }, [isScrolling, progress]);

  // Reverse easter egg
  useEffect(() => {
    if (direction === 'backward' && progress > 0.05 && progress < 0.4) {
      setShowReverse(true);
    } else {
      setShowReverse(false);
    }
  }, [direction, progress]);

  // Revealed words based on scroll progress
  const revealedWords = useMemo(() => {
    return QUOTE_WORDS.filter(w => progress >= w.milestone);
  }, [progress]);

  // Bicycle position during ride
  const bikeX = useMemo(() => {
    if (rideProgress <= 0) return 10;
    if (rideProgress >= 1) return 85;
    return 10 + rideProgress * 75;
  }, [rideProgress]);

  // Wobble style
  const wobbleStyle = useMemo(() => {
    if (bikeFallen) return {};
    if (wobbleLevel === 2) return { animation: 'wobbleHard 0.3s ease infinite' };
    if (wobbleLevel === 1) return { animation: 'wobble 0.5s ease infinite' };
    return {};
  }, [wobbleLevel, bikeFallen]);

  // Keyboard support
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
        window.scrollBy({ top: 100, behavior: 'smooth' });
      } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
        window.scrollBy({ top: -100, behavior: 'smooth' });
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  // Embers/fireflies for showcase section
  const [embers] = useState(() =>
    Array.from({ length: 20 }, (_, i) => ({
      id: i,
      left: Math.random() * 100,
      delay: Math.random() * 5,
      duration: 3 + Math.random() * 4,
      size: 2 + Math.random() * 4,
    }))
  );

  // Sound state
  const [soundEnabled, setSoundEnabled] = useState(false);
  const audioCtxRef = useRef<AudioContext | null>(null);
  const oscillatorRef = useRef<OscillatorNode | null>(null);
  const gainRef = useRef<GainNode | null>(null);

  const toggleSound = useCallback(() => {
    if (!soundEnabled) {
      try {
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 220;
        gain.gain.value = 0.02;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        audioCtxRef.current = ctx;
        oscillatorRef.current = osc;
        gainRef.current = gain;
        setSoundEnabled(true);
      } catch {
        // Web Audio not supported
      }
    } else {
      oscillatorRef.current?.stop();
      audioCtxRef.current?.close();
      audioCtxRef.current = null;
      oscillatorRef.current = null;
      gainRef.current = null;
      setSoundEnabled(false);
    }
  }, [soundEnabled]);

  // Modulate sound with scroll
  useEffect(() => {
    if (soundEnabled && gainRef.current && oscillatorRef.current) {
      const vol = isScrolling ? 0.02 + Math.min(velocity * 0.005, 0.05) : 0.005;
      gainRef.current.gain.linearRampToValueAtTime(vol, (audioCtxRef.current?.currentTime ?? 0) + 0.1);
      oscillatorRef.current.frequency.linearRampToValueAtTime(
        180 + velocity * 20,
        (audioCtxRef.current?.currentTime ?? 0) + 0.1
      );
    }
  }, [soundEnabled, isScrolling, velocity]);

  return (
    <div className="relative bg-charcoal min-h-screen">
      <CustomCursor />
      <ScrollProgressBar progress={progress} />

      {/* Sound toggle */}
      <button
        onClick={toggleSound}
        className="fixed top-4 right-4 z-50 w-10 h-10 flex items-center justify-center rounded-full border border-warm-white/20 text-warm-white/60 hover:text-warm-white hover:border-warm-white/40 transition-all text-sm interactive print:hidden"
        aria-label={soundEnabled ? 'Mute sound' : 'Enable sound'}
      >
        {soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡'}
      </button>

      {/* ===================== SECTION 1: HERO / INTRO ===================== */}
      <section
        className="relative h-screen flex flex-col items-center justify-center overflow-hidden"
        aria-label="Introduction"
        style={{
          background: 'linear-gradient(180deg, #0a0a1a 0%, #1a1a2e 100%)',
        }}
      >
        {/* Road line draws itself */}
        <div className="absolute top-1/2 left-0 right-0 h-[2px] -translate-y-1/2 overflow-hidden">
          <div
            className="h-full bg-warm-white/30"
            style={{
              width: bikeAssembled ? '100%' : '0%',
              transition: 'width 1.5s ease-out',
            }}
          />
        </div>

        {/* Bicycle assembles */}
        <div
          className="relative z-10"
          style={{
            opacity: heroProgress < 0.8 ? 1 : 1 - (heroProgress - 0.8) * 5,
          }}
        >
          <BicycleSVG animate={true} wheelRotation={0} />
        </div>

        {/* Scroll indicator */}
        <div
          className="absolute bottom-12 flex flex-col items-center gap-3"
          style={{
            opacity: bikeAssembled ? (progress < 0.02 ? 1 : 0) : 0,
            transition: 'opacity 0.5s ease',
          }}
        >
          <span className="text-warm-white/60 text-sm font-sans tracking-widest uppercase">
            Scroll to ride
          </span>
          <svg
            width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" strokeWidth="2" strokeLinecap="round"
            className="text-warm-white/40"
            style={{ animation: 'scrollArrow 2s ease infinite' }}
          >
            <path d="M12 5v14M5 12l7 7 7-7" />
          </svg>
        </div>
      </section>

      {/* ===================== SECTION 2: THE RIDE ===================== */}
      <section
        className="relative overflow-hidden"
        style={{ height: '250vh' }}
        aria-label="The bicycle ride"
      >
        <div className="sticky top-0 h-screen overflow-hidden">
          {/* Parallax Background */}
          <ParallaxScene progress={rideProgress} />

          {/* Particle Trail */}
          <ParticleTrail
            active={isScrolling && rideProgress > 0 && rideProgress < 1}
            originX={typeof window !== 'undefined' ? (bikeX / 100) * window.innerWidth : 0}
            originY={typeof window !== 'undefined' ? window.innerHeight * 0.78 : 0}
          />

          {/* Bicycle on the road */}
          <div
            className="absolute z-20"
            style={{
              left: `${bikeX}%`,
              bottom: '12%',
              transform: 'translateX(-50%) translateY(25%)',
              willChange: 'left',
              transition: isScrolling ? 'none' : 'left 0.3s ease-out',
              ...wobbleStyle,
            }}
          >
            <BicycleSVG
              wheelRotation={wheelRotation.current}
              fallen={bikeFallen}
              scale={1.5}
            />
          </div>

          {/* Keep moving message */}
          {showKeepMoving && (
            <div
              className="absolute inset-0 z-30 flex items-center justify-center"
              style={{ animation: 'fadeInUp 0.6s ease' }}
            >
              <p className="font-serif italic text-2xl text-sunset/80">
                Keep moving...
              </p>
            </div>
          )}

          {/* Reverse easter egg */}
          {showReverse && (
            <div className="absolute top-8 left-1/2 -translate-x-1/2 z-30">
              <p className="text-warm-white/40 text-sm">ðŸ”„ Going back?</p>
            </div>
          )}

          {/* Quote words revealing */}
          <div className="absolute top-[10%] left-0 right-0 z-20 text-center px-6">
            <p className="font-serif italic text-3xl md:text-5xl lg:text-6xl text-warm-white leading-relaxed max-w-4xl mx-auto">
              {QUOTE_WORDS.map((word, i) => (
                <span
                  key={i}
                  className="inline-block mr-[0.3em] transition-all duration-700"
                  style={{
                    opacity: revealedWords.includes(word) ? 1 : 0,
                    transform: revealedWords.includes(word) ? 'translateY(0)' : 'translateY(20px)',
                    textShadow: i === QUOTE_WORDS.length - 1 && revealedWords.includes(word)
                      ? '0 0 30px rgba(245, 166, 35, 0.4)'
                      : 'none',
                  }}
                >
                  {word.text}{' '}
                </span>
              ))}
            </p>
          </div>
        </div>
      </section>

      {/* ===================== SECTION 3: QUOTE SHOWCASE ===================== */}
      <section
        className="relative min-h-screen flex flex-col items-center justify-center overflow-hidden py-20"
        style={{
          background: `linear-gradient(180deg, 
            ${showcaseProgress > 0 ? '#16213e' : '#0a0a1a'} 0%, 
            ${showcaseProgress > 0.3 ? '#533483' : '#1a1a2e'} 40%, 
            ${showcaseProgress > 0.5 ? '#e94560' : '#16213e'} 80%, 
            ${showcaseProgress > 0.7 ? '#f5a623' : '#1a1a2e'} 100%)`,
          transition: 'background 1s ease',
        }}
        aria-label="Complete quote display"
      >
        {/* Floating embers */}
        {embers.map(e => (
          <div
            key={e.id}
            className="absolute rounded-full pointer-events-none"
            style={{
              width: `${e.size}px`,
              height: `${e.size}px`,
              left: `${e.left}%`,
              bottom: '10%',
              background: `radial-gradient(circle, #f5a623, #e94560)`,
              animation: `embers ${e.duration}s ease-in-out infinite`,
              animationDelay: `${e.delay}s`,
              opacity: showcaseProgress > 0.3 ? 0.6 : 0,
              transition: 'opacity 1s',
            }}
          />
        ))}

        <div
          className="relative z-10 text-center px-6 max-w-4xl mx-auto"
          style={{
            opacity: showcaseProgress > 0.2 ? 1 : 0,
            transform: showcaseProgress > 0.2 ? 'translateY(0)' : 'translateY(40px)',
            transition: 'all 0.8s ease',
          }}
        >
          {/* Parked bicycle */}
          <div className="flex justify-center mb-12" style={{ animation: 'glowPulse 3s ease-in-out infinite' }}>
            <BicycleSVG wheelRotation={0} scale={2.2} />
          </div>

          {/* Full quote with interactive keywords */}
          <blockquote className="font-serif italic text-3xl md:text-5xl lg:text-6xl leading-snug md:leading-snug text-warm-white mb-8">
            <span>&ldquo;</span>
            <span className="quote-word-life interactive cursor-pointer transition-all duration-300 hover:text-gold" tabIndex={0} role="button" aria-label="Life - hover for effect">Life</span>
            {' '}is just like riding a{' '}
            <span className="quote-word-bicycle interactive cursor-pointer transition-all duration-300 hover:text-gold" tabIndex={0} role="button" aria-label="Bicycle - hover for effect">bicycle</span>
            .
            <br className="hidden md:block" />{' '}
            In order to{' '}
            <span className="quote-word-balance interactive cursor-pointer transition-all duration-300 hover:text-sunset" tabIndex={0} role="button" aria-label="Balance - hover for effect">balance</span>
            ,
            <br className="hidden md:block" />{' '}
            you must keep{' '}
            <span className="quote-word-moving interactive cursor-pointer transition-all duration-300 hover:text-gold" tabIndex={0} role="button" aria-label="Moving - hover for effect">moving</span>
            .&rdquo;
          </blockquote>

          <p
            className="text-gold text-lg md:text-xl font-sans font-light tracking-wide"
            style={{
              opacity: showcaseProgress > 0.5 ? 1 : 0,
              transition: 'opacity 0.6s ease 0.3s',
            }}
          >
            â€” Albert Einstein
          </p>
          <p
            className="text-warm-white/30 text-xs mt-2 font-sans"
            style={{
              opacity: showcaseProgress > 0.6 ? 1 : 0,
              transition: 'opacity 0.6s ease 0.5s',
            }}
          >
            From a letter to his son Eduard, February 5, 1930
          </p>
        </div>
      </section>

      {/* ===================== SECTION 4: BREAKDOWN CARDS ===================== */}
      <section
        className="relative py-24"
        style={{
          background: 'linear-gradient(180deg, #0a0a1a 0%, #1a1a2e 100%)',
          opacity: cardsProgress > 0 ? 1 : 0.5,
          transition: 'opacity 0.5s',
        }}
        aria-label="Quote breakdown"
      >
        <div className="text-center mb-16 px-6">
          <h2 className="font-serif italic text-2xl md:text-4xl text-warm-white mb-4">
            Four words. One truth.
          </h2>
          <div className="h-[1px] bg-gradient-to-r from-transparent via-gold/40 to-transparent max-w-xs mx-auto" />
        </div>
        <QuoteBreakdownCards />
      </section>

      {/* ===================== SECTION 5: BALANCE PLAYGROUND ===================== */}
      <section
        className="relative py-24"
        style={{
          background: 'linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%)',
        }}
        aria-label="Interactive balance playground"
      >
        <div className="max-w-2xl mx-auto px-6">
          <BalancePlayground />
        </div>
      </section>

      {/* ===================== SECTION 6: FOOTER ===================== */}
      <section
        style={{
          background: 'linear-gradient(180deg, #1a1a2e 0%, #0a0a1a 100%)',
        }}
      >
        <Footer />
      </section>
    </div>
  );
}
